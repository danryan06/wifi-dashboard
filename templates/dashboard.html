<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Wi-Fi Test Dashboard v5.1 Optimized</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <style>
        /* [Keep all your existing styles from dashboard.html] */
        /* I'm only adding the new styles needed for traffic intensity controls */
        
        .traffic-intensity-control {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid var(--accent);
        }
        
        .intensity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .intensity-label {
            font-weight: 600;
            color: var(--accent);
            font-size: 1.1em;
        }
        
        .intensity-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .intensity-heavy {
            background: var(--error);
            color: white;
        }
        
        .intensity-medium {
            background: var(--warning);
            color: black;
        }
        
        .intensity-light {
            background: var(--success);
            color: white;
        }
        
        .intensity-selector {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .intensity-option {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255,255,255,0.03);
        }
        
        .intensity-option:hover {
            background: rgba(255,255,255,0.08);
            border-color: var(--accent);
        }
        
        .intensity-option.selected {
            border-color: var(--accent);
            background: rgba(76, 175, 80, 0.2);
        }
        
        .intensity-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
            font-size: 0.85em;
            color: var(--muted);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-weight: 600;
            color: var(--fg);
        }
        
        /* Add to existing styles */
    </style>
    
    <!-- Include all existing styles from your dashboard.html -->
</head>
<body>
    <!-- Keep your existing topbar exactly as is -->
    <div class="topbar">
        <div class="logo">üåê Wi-Fi Test Dashboard v5.1 Optimized</div>
        <div class="nav-links">
            <a href="/" class="nav-link active">üìä Dashboard</a>
            <a href="/traffic_control" class="nav-link">üö¶ Traffic Control</a>
        </div>
        <div class="tabs">
            <div class="tab active" data-tab="status">üìä Status</div>
            <div class="tab" data-tab="interfaces">üîå Interfaces</div>
            <div class="tab" data-tab="wifi">üì∂ Wi-Fi Config</div>
            <div class="tab" data-tab="traffic">üöÄ Traffic Intensity</div> <!-- NEW TAB -->
            <div class="tab" data-tab="netem">üåê Network Emulation</div>
            <div class="tab" data-tab="services">‚öôÔ∏è Services</div>
            <div class="tab" data-tab="logs">üìã Logs</div>
            <div class="tab" data-tab="controls">üîß System</div>
        </div>
        <div class="status-pill" id="status-pill"><span class="spinner"></span> Loading...</div>
    </div>

    <!-- Keep your existing flash messages -->
    <div class="flash-messages" id="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="content">
        <!-- Keep all your existing tabs: Status, Interfaces, Wi-Fi Config -->
        <!-- I'm only adding the NEW Traffic Intensity tab -->
        
        <!-- NEW: Traffic Intensity Tab -->
        <div id="traffic" class="card hidden">
            <h2>üöÄ Traffic Intensity Configuration</h2>
            <p style="color: var(--muted); margin-bottom: 24px;">
                Control traffic generation intensity for each interface. Changes require service restart to take effect.
            </p>
            
            <!-- Wired Interface (eth0) -->
            <div class="traffic-intensity-control">
                <div class="intensity-header">
                    <div class="intensity-label">üîå Ethernet (eth0) - Wired Client</div>
                    <div class="intensity-badge intensity-heavy" id="eth0-current-badge">HEAVY</div>
                </div>
                
                <div class="intensity-selector">
                    <div class="intensity-option" data-interface="eth0" data-intensity="light">
                        <div style="font-weight: 600; margin-bottom: 4px;">Light</div>
                        <div style="font-size: 0.85em; color: var(--muted);">10MB downloads</div>
                        <div style="font-size: 0.85em; color: var(--muted);">1-2 concurrent</div>
                    </div>
                    <div class="intensity-option" data-interface="eth0" data-intensity="medium">
                        <div style="font-weight: 600; margin-bottom: 4px;">Medium</div>
                        <div style="font-size: 0.85em; color: var(--muted);">50MB downloads</div>
                        <div style="font-size: 0.85em; color: var(--muted);">2-3 concurrent</div>
                    </div>
                    <div class="intensity-option selected" data-interface="eth0" data-intensity="heavy">
                        <div style="font-weight: 600; margin-bottom: 4px;">Heavy</div>
                        <div style="font-size: 0.85em; color: var(--muted);">100MB downloads</div>
                        <div style="font-size: 0.85em; color: var(--muted);">5 concurrent</div>
                    </div>
                </div>
                
                <div class="intensity-stats">
                    <div class="stat-item">
                        <div>CPU Usage</div>
                        <div class="stat-value">30-50%</div>
                    </div>
                    <div class="stat-item">
                        <div>Throughput</div>
                        <div class="stat-value">50-150 Mbps</div>
                    </div>
                    <div class="stat-item">
                        <div>Cycle Time</div>
                        <div class="stat-value">30s</div>
                    </div>
                </div>
            </div>
            
            <!-- Wi-Fi Good Interface (wlan0) -->
            <div class="traffic-intensity-control">
                <div class="intensity-header">
                    <div class="intensity-label">üì∂ Wi-Fi Primary (wlan0) - Good Client + Roaming</div>
                    <div class="intensity-badge intensity-medium" id="wlan0-current-badge">MEDIUM</div>
                </div>
                
                <div class="intensity-selector">
                    <div class="intensity-option" data-interface="wlan0" data-intensity="light">
                        <div style="font-weight: 600; margin-bottom: 4px;">Light</div>
                        <div style="font-size: 0.85em; color: var(--muted);">10MB downloads</div>
                        <div style="font-size: 0.85em; color: var(--muted);">1 concurrent</div>
                    </div>
                    <div class="intensity-option selected" data-interface="wlan0" data-intensity="medium">
                        <div style="font-weight: 600; margin-bottom: 4px;">Medium</div>
                        <div style="font-size: 0.85em; color: var(--muted);">25MB downloads</div>
                        <div style="font-size: 0.85em; color: var(--muted);">2-3 concurrent</div>
                    </div>
                    <div class="intensity-option" data-interface="wlan0" data-intensity="heavy">
                        <div style="font-weight: 600; margin-bottom: 4px;">Heavy</div>
                        <div style="font-size: 0.85em; color: var(--muted);">50MB downloads</div>
                        <div style="font-size: 0.85em; color: var(--muted);">3 concurrent</div>
                    </div>
                </div>
                
                <div class="intensity-stats">
                    <div class="stat-item">
                        <div>CPU Usage</div>
                        <div class="stat-value">15-25%</div>
                    </div>
                    <div class="stat-item">
                        <div>Throughput</div>
                        <div class="stat-value">10-30 Mbps</div>
                    </div>
                    <div class="stat-item">
                        <div>Cycle Time</div>
                        <div class="stat-value">60s</div>
                    </div>
                </div>
            </div>
            
            <!-- Wi-Fi Bad Interface (wlan1) -->
            <div class="traffic-intensity-control">
                <div class="intensity-header">
                    <div class="intensity-label">‚ùå Wi-Fi Secondary (wlan1) - Bad Client (Auth Failures)</div>
                    <div class="intensity-badge intensity-light" id="wlan1-current-badge">LIGHT</div>
                </div>
                
                <div class="intensity-selector">
                    <div class="intensity-option selected" data-interface="wlan1" data-intensity="light">
                        <div style="font-weight: 600; margin-bottom: 4px;">Light</div>
                        <div style="font-size: 0.85em; color: var(--muted);">Auth failures only</div>
                        <div style="font-size: 0.85em; color: var(--muted);">Minimal traffic</div>
                    </div>
                    <div class="intensity-option" data-interface="wlan1" data-intensity="medium">
                        <div style="font-weight: 600; margin-bottom: 4px;">Medium</div>
                        <div style="font-size: 0.85em; color: var(--muted);">Auth + light probes</div>
                        <div style="font-size: 0.85em; color: var(--muted);">Some traffic</div>
                    </div>
                    <div class="intensity-option" data-interface="wlan1" data-intensity="heavy">
                        <div style="font-weight: 600; margin-bottom: 4px;">Heavy</div>
                        <div style="font-size: 0.85em; color: var(--muted);">Not recommended</div>
                        <div style="font-size: 0.85em; color: var(--muted);">For testing only</div>
                    </div>
                </div>
                
                <div class="intensity-stats">
                    <div class="stat-item">
                        <div>CPU Usage</div>
                        <div class="stat-value">5-10%</div>
                    </div>
                    <div class="stat-item">
                        <div>Throughput</div>
                        <div class="stat-value">< 1 Mbps</div>
                    </div>
                    <div class="stat-item">
                        <div>Failure Interval</div>
                        <div class="stat-value">45s</div>
                    </div>
                </div>
            </div>
            
            <div style="background: rgba(255,152,0,0.1); padding: 16px; border-radius: 8px; border-left: 4px solid var(--warning); margin-top: 24px;">
                <div style="font-weight: 600; margin-bottom: 8px;">‚ö†Ô∏è Important Notes</div>
                <ul style="margin: 0; padding-left: 20px; color: var(--muted);">
                    <li>Changes will be saved to settings.conf but require service restart to take effect</li>
                    <li>Heavy traffic may impact Pi performance - monitor CPU usage</li>
                    <li>Recommended: Heavy (eth0), Medium (wlan0), Light (wlan1)</li>
                    <li>For Pi 3B+, use Medium/Light settings to avoid overload</li>
                </ul>
            </div>
            
            <div style="margin-top: 24px; display: flex; gap: 12px;">
                <button onclick="saveTrafficIntensity()">üíæ Save Configuration</button>
                <button onclick="saveAndRestartServices()" class="secondary">üíæ Save & Restart Services</button>
                <button onclick="resetTrafficIntensity()" class="secondary">üîÑ Reset to Defaults</button>
            </div>
        </div>

        <!-- Keep all your other existing tabs unchanged -->
    </div>

    <script>
        // Keep ALL your existing JavaScript
        // I'm only adding the new functions for traffic intensity
        
        // Traffic Intensity Functions
        let selectedIntensities = {
            'eth0': 'heavy',
            'wlan0': 'medium',
            'wlan1': 'light'
        };
        
        // Handle intensity option clicks
        document.addEventListener('click', function(e) {
            if (e.target.closest('.intensity-option')) {
                const option = e.target.closest('.intensity-option');
                const interface_name = option.dataset.interface;
                const intensity = option.dataset.intensity;
                
                // Remove selected from siblings
                option.parentElement.querySelectorAll('.intensity-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Add selected to clicked option
                option.classList.add('selected');
                
                // Update stored selection
                selectedIntensities[interface_name] = intensity;
                
                // Update badge
                updateIntensityBadge(interface_name, intensity);
                
                // Update stats display
                updateIntensityStats(option, intensity);
            }
        });
        
        function updateIntensityBadge(interface_name, intensity) {
            const badge = document.getElementById(`${interface_name}-current-badge`);
            if (badge) {
                badge.textContent = intensity.toUpperCase();
                badge.className = 'intensity-badge intensity-' + intensity;
            }
        }
        
        function updateIntensityStats(optionElement, intensity) {
            const parentControl = optionElement.closest('.traffic-intensity-control');
            const statsContainer = parentControl.querySelector('.intensity-stats');
            
            const stats = {
                'eth0': {
                    light: { cpu: '5-10%', throughput: '1-5 Mbps', cycle: '120s' },
                    medium: { cpu: '15-25%', throughput: '10-30 Mbps', cycle: '60s' },
                    heavy: { cpu: '30-50%', throughput: '50-150 Mbps', cycle: '30s' }
                },
                'wlan0': {
                    light: { cpu: '5-10%', throughput: '1-5 Mbps', cycle: '120s' },
                    medium: { cpu: '15-25%', throughput: '10-30 Mbps', cycle: '60s' },
                    heavy: { cpu: '30-50%', throughput: '30-60 Mbps', cycle: '30s' }
                },
                'wlan1': {
                    light: { cpu: '5-10%', throughput: '< 1 Mbps', cycle: '45s' },
                    medium: { cpu: '10-15%', throughput: '1-5 Mbps', cycle: '30s' },
                    heavy: { cpu: '15-25%', throughput: '5-10 Mbps', cycle: '20s' }
                }
            };
            
            const interface_name = optionElement.dataset.interface;
            const interfaceStats = stats[interface_name][intensity];
            
            const statValues = statsContainer.querySelectorAll('.stat-value');
            statValues[0].textContent = interfaceStats.cpu;
            statValues[1].textContent = interfaceStats.throughput;
            statValues[2].textContent = interfaceStats.cycle;
        }
        
        async function saveTrafficIntensity() {
            try {
                const formData = new FormData();
                formData.append('eth0_intensity', selectedIntensities['eth0']);
                formData.append('wlan0_intensity', selectedIntensities['wlan0']);
                formData.append('wlan1_intensity', selectedIntensities['wlan1']);
                
                const response = await fetch('/update_traffic_intensity', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showMessage('Traffic intensity configuration saved successfully!', 'success');
                    showMessage('Restart services for changes to take effect', 'info');
                } else {
                    showMessage('Failed to save traffic intensity configuration', 'error');
                }
            } catch (error) {
                showMessage('Error saving configuration: ' + error.message, 'error');
            }
        }
        
        async function saveAndRestartServices() {
            if (!confirm('Save configuration and restart all traffic services? This will cause brief service interruption.')) {
                return;
            }
            
            try {
                // First save the configuration
                const formData = new FormData();
                formData.append('eth0_intensity', selectedIntensities['eth0']);
                formData.append('wlan0_intensity', selectedIntensities['wlan0']);
                formData.append('wlan1_intensity', selectedIntensities['wlan1']);
                formData.append('restart_services', 'true');
                
                const response = await fetch('/update_traffic_intensity', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showMessage('Configuration saved and services restarting...', 'success');
                    showMessage('Please wait 10-15 seconds for services to restart', 'info');
                    
                    // Refresh data after delay
                    setTimeout(() => {
                        refreshData();
                        showMessage('Services restarted successfully!', 'success');
                    }, 15000);
                } else {
                    showMessage('Failed to save and restart services', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        function resetTrafficIntensity() {
            if (!confirm('Reset all interfaces to default traffic intensity settings?')) {
                return;
            }
            
            // Reset to defaults
            selectedIntensities = {
                'eth0': 'heavy',
                'wlan0': 'medium',
                'wlan1': 'light'
            };
            
            // Update UI
            document.querySelectorAll('.intensity-option').forEach(option => {
                const interface_name = option.dataset.interface;
                const intensity = option.dataset.intensity;
                
                if (selectedIntensities[interface_name] === intensity) {
                    option.classList.add('selected');
                    updateIntensityBadge(interface_name, intensity);
                } else {
                    option.classList.remove('selected');
                }
            });
            
            showMessage('Traffic intensity reset to defaults', 'info');
        }
        
        // Load current intensity settings on page load
        async function loadTrafficIntensity() {
            try {
                const response = await fetch('/api/traffic_intensity');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        selectedIntensities = data.intensities;
                        
                        // Update UI to reflect loaded settings
                        Object.entries(selectedIntensities).forEach(([iface, intensity]) => {
                            const option = document.querySelector(`.intensity-option[data-interface="${iface}"][data-intensity="${intensity}"]`);
                            if (option) {
                                option.parentElement.querySelectorAll('.intensity-option').forEach(opt => {
                                    opt.classList.remove('selected');
                                });
                                option.classList.add('selected');
                                updateIntensityBadge(iface, intensity);
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading traffic intensity:', error);
            }
        }
        
        // Call on tab switch to traffic
        document.querySelectorAll(".tab").forEach(tab => {
            tab.onclick = () => {
                switchTab(tab.dataset.tab);
                if (tab.dataset.tab === 'traffic') {
                    loadTrafficIntensity();
                }
            };
        });
        
        // Keep ALL your existing JavaScript functions unchanged
        // (refreshData, updateUI, serviceAction, etc.)
    </script>
</body>
</html>